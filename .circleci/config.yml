version: 2.1

executors:
  cpalgo:
    docker:
      - image: xirc/cp-algorithm
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD

jobs:
  bazel-lint:
    executor: cpalgo
    steps:
      - checkout
      - restore_cache:
          keys:
            - bazel
      - run:
          name: Lint All
          command: |
            buildifier --mode=diff --lint=warn --warnings=all -r lib
      - save_cache:
          key: bazel
          paths:
            - ~/.cache
            - lib/bazel-bin
            - lib/bazel-lib
            - lib/bazel-out
  build:
    executor: cpalgo
    steps:
      - checkout
      - restore_cache:
          keys:
            - bazel
      - run:
          name: Build All
          command: |
            cd lib
            bazelisk build //cpalgo/...:* //main/...:*
      - save_cache:
          key: bazel
          paths:
            - ~/.cache
            - lib/bazel-bin
            - lib/bazel-lib
            - lib/bazel-out
  test:
    executor: cpalgo
    steps:
      - checkout
      - restore_cache:
          keys:
            -bazel
      - run:
          name: Test library
          command: |
            cd lib
            bazelisk test //cpalgo/...:*
      - save_cache:
          key: bazel
          paths:
            - ~/.cache
            - lib/bazel-bin
            - lib/bazel-lib
            - lib/bazel-out

workflows:
  version: 2
  build:
    jobs:
      - bazel-lint:
          context:
            - docker-hub
      - build:
          requires:
            - bazel-lint
          context:
            - docker-hub
      - test:
          requires:
            - build
          context:
            - docker-hub