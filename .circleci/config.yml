version: 2.1

executors:
  cpalgo:
    docker:
      - image: xirc/cp-algorithm
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD

commands:
  restore_source_cache:
    steps:
      - restore_cache:
          keys:
            - source-{{ .Branch }}-{{ .Revision }}
            - source-{{ .Branch }}
            - source
  store_source_cache:
    steps:
      - run:
          name: Git GC
          command: git gc
      - save_cache:
          key: source-{{ .Branch }}-{{ .Revision }}
          paths:
            - .git
  restore_bazel_cache:
    steps:
      - restore_cache:
          keys:
            - bazel-{{ .Branch }}-{{ .Revision }}
            - bazel-{{ .Branch }}
            - bazel
  store_bazel_cache:
    steps:
      - save_cache:
          key: bazel-{{ .Branch }}-{{ .Revision }}
          paths:
            - ~/.cache/bazel
  restore_bazelisk_cache:
    steps:
      - restore_cache:
          keys:
            - bazelisk-{{ checksum ".bazelversion" }}
            - bazelisk
  store_bazelisk_cache:
    steps:
      - save_cache:
          key: bazelisk-{{ checksum ".bazelversion" }}
          paths:
            - ~/.cache/bazelisk

jobs:
  bazel-lint:
    executor: cpalgo
    steps:
      - restore_source_cache
      - checkout
      - store_source_cache
      - run:
          name: Lint All
          command: |
            buildifier --mode=diff --lint=warn --warnings=all -r lib
  build:
    executor: cpalgo
    steps:
      - restore_source_cache
      - checkout
      - store_source_cache
      - restore_bazelisk_cache
      - restore_bazel_cache
      - run:
          name: Build All
          command: |
            cd lib
            bazelisk build --jobs=HOST_RAM //cpalgo/...:* //main/...:*
  test:
    executor: cpalgo
    steps:
      - restore_source_cache
      - checkout
      - store_source_cache
      - restore_bazelisk_cache
      - restore_bazel_cache
      - run:
          name: Test library
          command: |
            cd lib
            bazelisk test --jobs=HOST_RAM //cpalgo/...:*
      - store_test_results:
          path: lib/bazel-testlogs/cpalgo
      - store_bazel_cache
      - store_bazelisk_cache

workflows:
  version: 2
  build:
    jobs:
      - bazel-lint:
          context:
            - docker-hub
      - build:
          requires:
            - bazel-lint
          context:
            - docker-hub
      - test:
          requires:
            - build
          context:
            - docker-hub